# 将来の開発計画: OpenWAM インタラクティブ・シミュレータ

## 1. 全体ビジョン

このプロジェクトの主な目的は、コマンドラインベースのOpenWAM C++エンジンシミュレーションツールを、完全にインタラクティブなウェブベースのアプリケーションに進化させることです。これにより、ユーザーはC++コードをコンパイルしたり、ローカルの実行可能ファイルを管理したりすることなく、最新のグラフィカルユーザーインターフェースを通じてエンジンパラメータを変更し、シミュレーション結果をリアルタイムで視覚化できるようになります。

## 2. 開発アプローチ

このビジョンを達成するため、2段階のアプローチを採用します。

1.  **Pythonによるプロトタイピング:** まず、Pythonで包括的なエンジンシミュレーションモデルを開発し、検証します。これにより、迅速なイテレーション、科学技術計算ライブラリ（NumPy, SciPy）の容易な統合、そして可読性の高いクリアなコードが可能になります。現在のBMW E46 M3用`engine_simulator`アプリケーションが、この段階の基盤となります。
2.  **C++/WebAssemblyへの移植:** Pythonプロトタイプが成熟し、検証された後、そのコアロジックを体系的に高性能なC++コードベースに移植します。このC++コアはWebAssembly（WASM）モジュールにコンパイルされ、Reactフロントエンドからの操作によってブラウザ上で効率的に実行されます。

このドキュメントは、主に**ステージ1：Pythonプロトタイピング**の詳細なロードマップに焦点を当てています。

## 3. Pythonプロトタイプ開発ロードマップ

このロードマップは、現在のPythonシミュレータを「肉付け」し、特定のVANOS解析ツールから、OpenWAMのアーキテクチャに基づいた本格的な1Dガスダイナミクス・エンジンシミュレーションプラットフォームへと変貌させるための段階的な計画を詳述します。

### フェーズ1: 体積効率とガス交換モデル（現在の焦点）

このフェーズでは、既存のVANOS計算フレームワークを基盤として、エンジンの吸排気能力に関する堅牢なモデルを構築します。

*   **目的:** エンジン回転数とバルブタイミングに基づいて体積効率（VE）を正確に予測する。
*   **主要タスク:**
    1.  **VE仕様の実装:** `components.py`内の`Cylinder.calculate_volumetric_efficiency`メソッドを、`BMW_E46_M3_VANOS_Volumetric_Efficiency_Specification.md`に完全に準拠するようリファクタリングする。これには以下が含まれます：
        *   現実的なRPMベースの基本VEカーブの実装。
        *   VANOSによるタイミング変更がVEに与える影響を正確にモデル化する`intake_factor`、`exhaust_factor`、`overlap_factor`関数の開発。
    2.  **オーバーラップ計算の改良:** `calculate_valve_overlap`メソッドをその詳細仕様に基づき強化し、すべてのエッジケースを正しく処理し、VEモデルに正確な開始・終了角度を提供できるようにする。
    3.  **閉じ込め空気量計算:** 計算されたVEを用いて、吸気バルブ閉弁（IVC）時点でのシリンダー内空気量を計算する信頼性の高いモデルを実装する。
    4.  **検証:** 新しいVEモデルを既知のエンジン特性や仕様書と照らし合わせて検証するため、新しいテストスクリプト（例: `test_volumetric_efficiency.py`）を作成する。

### フェーズ2: 筒内熱力学モデルの詳細化

このフェーズでは、エンジンサイクルシミュレーションの中核である閉鎖サイクルの熱力学を実装します。

*   **目的:** 圧縮、燃焼、膨張行程をシミュレートし、筒内圧、温度、トルクを正確に予測する。
*   **主要タスク:**
    1.  **第一法則ソルバーの実装:** `PYTHON_MODEL_DESIGN.md`で概説されている通り、`Cylinder.update`メソッド内に熱力学第一法則（`dU = dQ_comb - dQ_loss - dW`）の数値ソルバーを実装する。
    2.  **燃焼モデル（Wiebe）の実装:** 設定ファイルで定義されたWiebe関数パラメータを用いて熱発生率（`dQ_comb`）を計算する`Combustion`クラスまたはモジュールを作成する。
    3.  **熱損失モデル（Woschni）の実装:** Woschniの相関式を用いて壁面への熱損失率（`dQ_loss`）を計算する`HeatTransfer`クラスまたはモジュールを作成する。
    4.  **仕事の計算:** ピストンによってなされる仕事（`dW = P * dV`）を各ステップで計算する。
    5.  **状態積分:** 計算されたdUを用いて、各タイムステップでシリンダーの状態変数（圧力、温度）を更新する。
    6.  **検証:** P-V線図や筒内圧の履歴を生成し、4ストロークエンジンの期待される結果と照らし合わせて検証する。

### フェーズ3: 1Dガスダイナミクスモデルの実装（波動効果）

これは最も複雑なフェーズであり、シミュレータをオリジナルのOpenWAMのような真の1Dガスダイナミクスツールへと変貌させます。

*   **目的:** 吸排気管内の圧力波の動特性をシミュレートし、音響共鳴効果がエンジン吸気に与える影響を捉える。
*   **主要タスク:**
    1.  **`Pipe`クラスの実装:** 各セルごとの状態（圧力、速度、温度、密度）を保持する、離散化された1Dダクトを表現する`Pipe`クラスを持つ`gas_dynamics.py`モジュールを作成する。
    2.  **数値ソルバーの実装:** `Pipe.update`メソッド内に、1Dオイラー方程式を解くための数値解法（例: OpenWAMで使われているMacCormack法やCESE法）を実装する。
    3.  **境界条件の実装:**
        *   `TCondicionContorno`を模倣した`Boundary`クラス階層を作成する。
        *   `Pipe`と`Cylinder`を接続し、圧力差とバルブの有効面積に基づいて質量とエンタルピーの流れを計算する`CylinderBoundary`クラスを実装する。
        *   `OpenEnd`（大気開放）や`ClosedEnd`（閉鎖端）のような単純な境界条件を実装する。
    4.  **統合:** メインの`Simulator`ループを修正し、すべての`Pipe`および`Boundary`オブジェクトの`update`メソッドを呼び出し、連成解を保証するようにする。

### フェーズ4: 高度なコンポーネントと制御システム

このフェーズでは、より複雑なエンジン構成と制御戦略のサポートを追加します。

*   **目的:** シミュレータの能力を拡張し、現代の複雑なエンジンシステムをモデル化する。
*   **主要タスク:**
    1.  **過給機:** `Compressor`および`Turbine`コンポーネントを実装する（マップベースの性能モデルを含む）。それらを連結する`TurbochargerAxis`を実装する。
    2.  **高度なマニホールド:** `Plenum`（0Dチャンバー）および`Branch`（配管分岐）コンポーネントを実装する。
    3.  **制御システム:** `Source/Control`の`Sensor`および`Controller`クラス階層を実装し、`PIDController`や`TableController`（ECUマップ用）を含めることで、閉ループ制御シミュレーションを可能にする。

## 4. アプリケーション化：C++(WASM)への移植とUI/UX

このステージは、Pythonプロトタイプが十分な成熟度と検証レベルに達した後に開始されます。

*   **目的:** 高性能で、洗練されたUIを持つインタラクティブなツールを作成する。

### 4.1. C++リファクタリングとWebAssemblyコンパイル
*   **C++リファクタリング:** Pythonで検証されたロジックをC++のOpenWAMコードベースに移植し、`Specification.md`で特定されたレガシーなメモリ管理の問題に対処するために、現代的なC++プラクティス（RAII、スマートポインタ）を適用します。
*   **JSONインターフェース:** シミュレーションを設定・実行し、結果をJSON形式で返すための包括的なJSONオブジェクトを受け入れる単一のC++ラッパー関数を開発します。
*   **WebAssemblyコンパイル:** C++コアとラッパーをWASMモジュールにコンパイルします。

### 4.2. Web UI開発
*   **動的UI:** JSONスキーマに基づいてパラメータ編集フォームを動的に生成し、C++側でサポートされる全パラメータを編集可能にします。
*   **高度な可視化:** ユーザーが出力変数を自由に選択し、P-V線図、トルクカーブ、配管内圧力波など、多彩なグラフを描画できる、設定自由度の高いチャートコンポーネントを実装します。
*   **ケース管理:** ユーザーがシミュレーション設定（JSONオブジェクト）をローカルファイルとして保存・読み込みできる機能を提供します。
*   **UIの洗練:** モダンなデザインシステム（例: Material Design）を採用し、直感的な操作性とレスポンシブデザインを徹底することで、プロフェッショナルなツールとしての外観と優れたユーザー体験を目指します。

### 4.3. データ連携と分析機能
*   **走行ログとの比較検証:** 実際の走行ログデータ（CSV形式など）をインポートし、シミュレーション結果と重ねて表示する機能を実装します。これにより、モデルの妥当性検証や、パラメータ変更が実測値にどう影響するかの予測が可能になります。比較対象は、VANOS角、充填効率、吸気流量、エンジン回転数などを含みます。

## 5. 配布形式

最終的なアプリケーションは、以下の形式で提供することを目指します。

### 5.1. Webアプリケーション
*   サーバーにホスティングされ、ユーザーはブラウザ経由でアクセスします。インストール不要で、常に最新バージョンを利用できます。

### 5.2. スタンドアロン・デスクトップアプリケーション
*   **パッケージ化:** ElectronやTauriのような技術を利用し、WebアプリケーションをWindows, macOS, Linuxで動作するスタンドアロンのデスクトップアプリとしてパッケージ化します。これにより、オフライン環境での利用や、よりネイティブに近い操作感を提供します。